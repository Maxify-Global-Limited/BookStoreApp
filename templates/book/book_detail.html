{% extends 'base.html' %}

{% load static %}


{% block content%}

<!--************************************
				Inner Banner Start
		*************************************-->
		<div class="tg-innerbanner tg-haslayout tg-parallax tg-bginnerbanner" data-z-index="-100" data-appear-top-offset="600" data-parallax="scroll" data-image-src="{% static 'images/parallax/bgparallax-07.jpg' %}">
			<div class="container">
				<div class="row">
					<div class="col-xs-12 col-sm-12 col-md-12 col-lg-12">
						<div class="tg-innerbannercontent">
							<h1>Book Details</h1>
							<ol class="tg-breadcrumb">
								
								<li class="tg-active">{{book.title}}</li>
							</ol>
						</div>
					</div>
				</div>
			</div>
		</div>
		<!--************************************
				Inner Banner End
		*************************************-->
		<!--************************************
				Main Start
		*************************************-->
		<main id="tg-main" class="tg-main tg-haslayout">
			<!--************************************
					News Grid Start
			*************************************-->
			<div class="tg-sectionspace tg-haslayout">
				<div class="container">
					<div class="row">
						<div id="tg-twocolumns" class="tg-twocolumns">
							<div class="col-xs-12 col-sm-8 col-md-8 col-lg-9 pull-right">
								<div id="tg-content" class="tg-content">
									
									<div class="tg-productdetail">
										<div class="row">
											<div class="col-xs-12 col-sm-12 col-md-4 col-lg-4">
												<div class="tg-postbook">
													<figure class="tg-featureimg"><img src="{{book.cover.url}}" alt="image description"></figure>
													<div class="tg-postbookcontent" id="paymentDiv">
														<span class="tg-bookprice">
															<ins>{{book.price}}</ins>
															<del>$27.20</del>
														</span>
														<span class="tg-bookwriter">You save $4.02</span>
														
														
														<a class="tg-btn tg-active tg-btn-lg" onclick="payWithPaystack()" id="paystack-button" href="javascript:void(0);">Pay with Paystack</a>

														 {% comment %} <a class="tg-btn tg-active tg-btn-lg" onclick="makePayment()" id="flutterwave-button" href="javascript:void(0);">Pay wit Flutterwave</a> {% endcomment %}
														
													</div>
												</div>
											</div>
											<div class="col-xs-12 col-sm-12 col-md-8 col-lg-8">
												<div class="tg-productcontent">
													<ul class="tg-bookscategories">
                                                  
														<li>
                                                        {% for genre in book.genre.all%}
                                                        <a href="javascript:void(0);">
                                                        {{genre}}  </a></li>
                                                        {% endfor %}
													</ul>
													<div class="tg-themetagbox"><span class="tg-themetag">sale</span></div>
													<div class="tg-booktitle">
														<h3>{{book.title}}</h3>
													</div>
													<span class="tg-bookwriter">By: <a href="javascript:void(0);">{{book.author}}</a></span>
													
													<span class="tg-addreviews"><a href="javascript:void(0);"></a></span>
												
													<div class="tg-description">
														<p>{{book.description}}</p>
														
													</div>
													<div class="tg-sectionhead">
														<h2>Product Details</h2>
													</div>
													<ul class="tg-productinfo">
														<li><span>Format:</span><span>Hardback</span></li>
														<li><span>Pages:</span><span>528 pages</span></li>
														<li><span>Dimensions:</span><span>153 x 234 x 43mm | 758g</span></li>
														<li><span>Publication Date:</span><span>June 27, 2017</span></li>
														<li><span>Publisher:</span><span>Sunshine Orlando</span></li>
														<li><span>Language:</span><span>English</span></li>
														<li><span>Illustrations note:</span><span>b&amp;w images thru-out; 1 x 16pp colour plates</span></li>
														<li><span>ISBN10:</span><span>1234567890</span></li>
														<li><span>ISBN13:</span><span>1234567890000</span></li>
														<li><span>Other Fomate:</span><span>CD-Audio, Paperback, E-Book</span></li>
													</ul>
												</div>
											</div>



                                            	<div class="tg-productdescription">
												<div class="col-xs-12 col-sm-12 col-md-12 col-lg-12">
													<div class="tg-sectionhead">
														<h2>Product Description</h2>
													</div>
													<ul class="tg-themetabs" role="tablist">
														<li role="presentation" class="active"><a href="#description" data-toggle="tab">Description</a></li>
														<li role="presentation"><a href="#review" data-toggle="tab">Reviews</a></li>
													</ul>
													<div class="tg-tab-content tab-content">
														<div role="tabpanel" class="tg-tab-pane tab-pane active" id="description">
															<div class="tg-description">
																
																<p>{{book.description}}</p>
																
																
															</div>
														</div>
														<div role="tabpanel" class="tg-tab-pane tab-pane" id="review">
															<div class="tg-description">
                                                               {% for review in book.reviews.all %}
																<ul class="list-group">
																	<li class="list-group-item d-flex justify-content-between align-items-center">
																		{{review.content}}
																		<span class="badge badge-primary badge-pill">{{review.rating}} stars</span>
																	</li>
																  {% endfor%}
																</ul>
															</div>
														</div>
													</div>
												</div>
											</div>

                                        

											<div class="tg-aboutauthor">
												<div class="col-xs-12 col-sm-12 col-md-12 col-lg-12">
													<div class="tg-sectionhead">
														<h2>About Author</h2>
													</div>
													<div class="tg-authorbox">
														<figure class="tg-authorimg">
															<img src="{{book.author.pics.url}}" width="30" height="30" alt="image description">
														</figure>
														<div class="tg-authorinfo">
															<div class="tg-authorhead">
																<div class="tg-leftarea">
																	<div class="tg-authorname">
																		<h2>{{book.author}}</h2>
																		<span>Author Since: June 27, 2017</span>
																	</div>
																</div>
																
															</div>
															<div class="tg-description">
																<p>{{book.author.salutation}}</p>
															</div>
															<a class="tg-btn tg-active" href="javascript:void(0);">View All Books</a>
														</div>
													</div>
												</div>
											</div>
											
										</div>
									</div>
								</div>
							</div>
							<div class="col-xs-12 col-sm-4 col-md-4 col-lg-3 pull-left">
								<aside id="tg-sidebar" class="tg-sidebar">
									<div class="tg-widget tg-widgetsearch">
										<form class="tg-formtheme tg-formsearch">
											<div class="form-group">
												<button type="submit"><i class="icon-magnifier"></i></button>
												<input type="search" name="search" class="form-group" placeholder="Search by title, author, key...">
											</div>
										</form>
									</div>
									
									
									<div class="tg-widget tg-widgetinstagram">
										<div class="tg-widgettitle">
											<h3>Instagram</h3>
										</div>
										<div class="tg-widgetcontent">
											<ul>
												<li>
													<figure>
														<img src="{% static 'images/instagram/img-01.jpg' %}" alt="image description">
														<figcaption><a href="javascript:void(0);"><i class="icon-heart"></i><em>50,134</em></a></figcaption>
													</figure>
												</li>
												<li>
													<figure>
														<img src="{% static 'images/instagram/img-02.jpg' %}" alt="image description">
														<figcaption><a href="javascript:void(0);"><i class="icon-heart"></i><em>50,134</em></a></figcaption>
													</figure>
												</li>
												<li>
													<figure>
														<img src="{% static 'images/instagram/img-03.jpg' %}" alt="image description">
														<figcaption><a href="javascript:void(0);"><i class="icon-heart"></i><em>50,134</em></a></figcaption>
													</figure>
												</li>
												<li>
													<figure>
														<img src="{% static 'images/instagram/img-04.jpg' %}" alt="image description">
														<figcaption><a href="javascript:void(0);"><i class="icon-heart"></i><em>50,134</em></a></figcaption>
													</figure>
												</li>
												<li>
													<figure>
														<img src="{% static 'images/instagram/img-05.jpg' %}" alt="image description">
														<figcaption><a href="javascript:void(0);"><i class="icon-heart"></i><em>50,134</em></a></figcaption>
													</figure>
												</li>
												<li>
													<figure>
														<img src="{% static 'images/instagram/img-06.jpg' %}" alt="image description">
														<figcaption><a href="javascript:void(0);"><i class="icon-heart"></i><em>50,134</em></a></figcaption>
													</figure>
												</li>
												<li>
													<figure>
														<img src="{% static 'images/instagram/img-07.jpg' %}" alt="image description">
														<figcaption><a href="javascript:void(0);"><i class="icon-heart"></i><em>50,134</em></a></figcaption>
													</figure>
												</li>
												<li>
													<figure>
														<img src="{% static 'images/instagram/img-08.jpg' %}" alt="image description">
														<figcaption><a href="javascript:void(0);"><i class="icon-heart"></i><em>50,134</em></a></figcaption>
													</figure>
												</li>
												<li>
													<figure>
														<img src="{% static 'images/instagram/img-09.jpg' %}" alt="image description">
														<figcaption><a href="javascript:void(0);"><i class="icon-heart"></i><em>50,134</em></a></figcaption>
													</figure>
												</li>
											</ul>
										</div>
									</div>
								
								</aside>
							</div>
						</div>
					</div>
				</div>
			</div>
			<!--************************************
					News Grid End
			*************************************-->
		</main>
		<!--************************************
				Main End
		*************************************-->



<script>

    // Generate A CSRF Cookie
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                // Does this cookie string begin with the name we want?
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                    }
                }
            }
            return cookieValue;
        }       
    const csrftoken = getCookie('csrftoken');
    console.log('csrftoken===>', csrftoken)


    // Get Data from Django detail page
    var grand_total = "{{ book.price }}"

	 // PAYSTACK FUNCTION : Handles the payment process
	 const paymentForm = document.getElementById('paystack-button');
	 paymentForm.addEventListener("submit", payWithPaystack, false);

		function payWithPaystack(e) {

		let handler = PaystackPop.setup({
			key: "{{PAYSTACK_PUB_KEY}}", // Replace with your public key
			email: "{{user.email}}",
			amount:  grand_total * 100,
			ref: ''+Math.floor((Math.random() * 1000000000) + 1), // generates a pseudo-unique reference. Please replace with a reference you generated. Or remove the line entirely so our API will generate one for you
			// label: "Optional string that replaces customer email"
			currency: 'NGN',
			
			callback: function(response){
			let message = 'Payment complete! Reference: ' + response.reference;
			console.log(response)

			const element = document.getElementById('paystack-button');
                    element.innerHTML = '';
                    element.innerHTML = '<h6 class="text-center text-white" ><i class="fa fa-spinner fa-spin"></i> Please wait...</h6>';
                    
			redirect(response.status)
			},
			onClose: function(){
			alert('Transaction Failed and Window closed.');
			},
		});

		handler.openIframe();
			
		}
    // Function to Handle Alert and Page Redirect after payment

    function redirect(response_status = "success") {

        if (response_status === "success") {

            alert(response_status);
            window.location.href = "https://drive.google.com/file/d/1-ehG-4yk6hfdtqmo2-0DydSJxClYtlJy/view?usp=sharing"; //Downloadpage Upon Successful

        } else {
            alert(response_status);
            window.location.href = "{% url 'book_detail' book.pk %}"; // Book Detail page when unsuccessful
        }
    }


</script>

{% endblock content %}
